  <script>
    // Aurora configuration - UPDATED FOR CORRECT DATA FLOW
    const AURORA_CONFIG = {
      supabaseUrl: 'https://rcthtxwzsqvwivritzln.supabase.co',
      supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjdGh0eHd6c3F2d2l2cml0emxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NzM2MjAsImV4cCI6MjA2ODI0OTYyMH0._bSOH4oY3Ug1l-NY7OPnXQr4Mt5mD7WgugNKjlwWAkM',
      functionName: 'smart-meter-webhook', // Changed from 'super-action'
      // Proxy server URL - replace with your deployed proxy server URL
      proxyUrl: 'http://localhost:3001/proxy/supabase-function' // Update this to your deployed proxy URL
    };

    const meters = JSON.parse(localStorage.getItem("aurora_meters") || "[]");
    let angle = 0;
    let isSpinning = false;
    let isConnected = false;

    // Function to decode the encoded user ID back to original format
    function decodeUserId(encodedId) {
      try {
        // Convert the encoded string back to the original user ID
        let decoded = '';
        for (let i = 0; i < encodedId.length; i += 3) {
          const charCode = parseInt(encodedId.substr(i, 3));
          decoded += String.fromCharCode(charCode);
        }
        return decoded;
      } catch (error) {
        console.error('Error decoding user ID:', error);
        // If decoding fails, return the original encoded ID
        return encodedId;
      }
    }

    // Function to check if a string is an encoded user ID
    function isEncodedUserId(id) {
      // Check if the ID consists only of digits and has a length that's a multiple of 3
      return /^\d+$/.test(id) && id.length % 3 === 0;
    }

    // Update connection status display
    function updateConnectionStatus() {
      const statusEl = document.getElementById("connectionStatus");
      if (statusEl) {
        if (isConnected) {
          statusEl.className = "mb-4 p-2 rounded text-center text-sm font-medium bg-green-100 text-green-800";
          statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected to Aurora';
          const spinButton = document.getElementById("spinButton");
          if (spinButton) {
            spinButton.disabled = false;
          }
        } else {
          statusEl.className = "mb-4 p-2 rounded text-center text-sm font-medium bg-yellow-100 text-yellow-800";
          statusEl.innerHTML = '<i class="fas fa-plug"></i> Connecting to Aurora...';
          const spinButton = document.getElementById("spinButton");
          if (spinButton) {
            spinButton.disabled = true;
          }
        }
      }
    }

    // Check connection to Aurora
    async function checkConnection() {
      try {
        const response = await fetch(`${AURORA_CONFIG.supabaseUrl}/rest/v1/`, {
          method: 'HEAD',
          headers: {
            'apikey': AURORA_CONFIG.supabaseKey,
            'Authorization': `Bearer ${AURORA_CONFIG.supabaseKey}`
          }
        });
        
        isConnected = response.ok;
      } catch (error) {
        isConnected = false;
        console.error('Connection error:', error);
      }
      
      updateConnectionStatus();
    }

    // Populate meter selector
    function populateMeterSelect() {
      const select = document.getElementById("meter_select");
      if (select) {
        select.innerHTML = '<option value="">– Select Registered Meter –</option>';
        
        meters.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m.split("::")[1];
          select.appendChild(opt);
        });
      }
    }

    // Show toast notification
    function showToast(msg, success = true) {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast-notification');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement("div");
      toast.textContent = msg;
      toast.className = `toast-notification fixed top-6 left-1/2 transform -translate-x-1/2 px-4 py-2 text-sm rounded shadow z-50 ${
        success ? "bg-green-500 text-white" : "bg-red-500 text-white"
      }`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 2500);
    }

    // Register a new meter
    function registerMeter() {
      const userIdInput = document.getElementById('user_id_input');
      const meterNumberInput = document.getElementById('meter_number_input');
      
      if (!userIdInput || !meterNumberInput) {
        return showToast("Form elements not found", false);
      }
      
      let user = userIdInput.value.trim();
      const meter = meterNumberInput.value.trim();
      
      if (!user || !meter) {
        return showToast("Both fields are required", false);
      }

      // If the user ID appears to be encoded, store both encoded and original versions
      if (isEncodedUserId(user)) {
        // Store the encoded version for display but use the decoded version for internal operations
        const originalUserId = decodeUserId(user);
        const combo = `${user}::${meter}`; // Store encoded version for display
        const internalCombo = `${originalUserId}::${meter}`; // Use original for operations
        
        if (!meters.includes(internalCombo)) {
          meters.push(internalCombo);
          localStorage.setItem("aurora_meters", JSON.stringify(meters));
          populateMeterSelect();
          userIdInput.value = "";
          meterNumberInput.value = "";
          showToast("Meter registered successfully ✔️");
        } else {
          showToast("Meter already registered", false);
        }
      } else {
        // Standard registration for non-encoded user IDs
        const combo = `${user}::${meter}`;
        if (!meters.includes(combo)) {
          meters.push(combo);
          localStorage.setItem("aurora_meters", JSON.stringify(meters));
          populateMeterSelect();
          userIdInput.value = "";
          meterNumberInput.value = "";
          showToast("Meter registered successfully ✔️");
        } else {
          showToast("Meter already registered", false);
        }
      }
    }

    // Spin the meter and send data to Aurora
    async function spin() {
      if (isSpinning || !isConnected) return;
      
      const meterSelect = document.getElementById("meter_select");
      if (!meterSelect) {
        return showToast("Meter selector not found", false);
      }
      
      const selected = meterSelect.value;
      if (!selected) {
        return showToast("Select a meter first", false);
      }
      
      isSpinning = true;
      const spinButton = document.getElementById("spinButton");
      if (spinButton) {
        spinButton.disabled = true;
      }
      
      // Add spinning animation
      const wheel = document.getElementById("wheel");
      if (wheel) {
        wheel.classList.remove("pulse");
      }
      
      // Generate random kWh reading
      const [user, meter] = selected.split("::");
      const kwh = (Math.random() * 15 + 5).toFixed(2); // 5-20 kWh
      const kwhDisplay = document.getElementById("kwhDisplay");
      if (kwhDisplay) {
        kwhDisplay.textContent = kwh;
      }
      
      // Animate the wheel
      angle += 360 + Math.random() * 1080;
      if (wheel) {
        wheel.style.transform = `rotate(${angle}deg)`;
      }
      
      // Decode user ID if it's encoded
      const originalUserId = isEncodedUserId(user) ? decodeUserId(user) : user;
      
      // Prepare payload with CORRECT structure for smart-meter-webhook
      const payload = {
        url: `${AURORA_CONFIG.supabaseUrl}/functions/v1/${AURORA_CONFIG.functionName}`,
        meter_number: meter,
        kwh_consumed: parseFloat(kwh),
        user_id: originalUserId,
        cost_per_kwh: 25.0 // Add this field
      };
      
      // Update response box
      const responseBox = document.getElementById("responseBox");
      if (responseBox) {
        responseBox.textContent = "Sending data to Aurora...";
      }
      
      try {
        // Send data to Aurora through the proxy server with CORRECT structure
        const response = await fetch(AURORA_CONFIG.proxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload) // Use the corrected payload
        });
        
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update UI with response
        if (responseBox) {
          responseBox.textContent = JSON.stringify(data, null, 2);
        }
        
        // Add to history
        const historyList = document.getElementById("history_log");
        if (historyList) {
          if (historyList.firstChild?.classList?.contains('italic')) {
            historyList.innerHTML = '';
          }
          
          const li = document.createElement("li");
          li.className = "p-2 bg-blue-50 rounded flex justify-between";
          li.innerHTML = `
            <span>${new Date().toLocaleTimeString()}</span>
            <span class="font-medium">${meter}: <span class="text-blue-600">${kwh} kWh</span></span>
          `;
          historyList.prepend(li);
        }
        
        showToast("Reading sent to Aurora ✔️");
      } catch (error) {
        console.error('Error sending data:', error);
        
        // More detailed error handling
        if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
          if (responseBox) {
            responseBox.textContent = `❌ Network Error: Unable to send data to proxy server. Make sure the proxy server is running.`;
          }
          showToast("Network Error: Check proxy server ❌", false);
        } else {
          if (responseBox) {
            responseBox.textContent = `❌ Error: ${error.message}`;
          }
          showToast("Failed to send reading ❌", false);
        }
      } finally {
        // Reset spinning state
        setTimeout(() => {
          isSpinning = false;
          if (spinButton) {
            spinButton.disabled = false;
          }
          if (wheel) {
            wheel.classList.add("pulse");
          }
        }, 1000);
      }
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      updateConnectionStatus();
      populateMeterSelect();
      checkConnection();
    });
  </script>